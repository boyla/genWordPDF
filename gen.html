<!DOCTYPE html>
<html>

<head>
    <title>施工组织设计生成</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Cache-Control" content="only-if-cached">
    <style>
        pre {
            white-space: pre-wrap;
            /* CSS-3 /
           white-space: -moz-pre-wrap; / Mozilla, since 1999 /
           white-space: -pre-wrap; / Opera 4-6 /
           white-space: -o-pre-wrap; / Opera 7 /
           Word-wrap: break-word; / Internet Explorer 5.5+ */
        }
    </style>

    <script type="text/javascript" src="vue2.7.js"></script>
    <link href="https://cdn.staticfile.org/twitter-bootstrap/5.1.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.staticfile.org/twitter-bootstrap/5.1.1/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="model.js"></script>
    <script type="module" src="font-han-sans.js?v=1.1"></script>
    <script src="jspdf.min.js"></script>

</head>

<body>
<div id="app">
    <div class="container-fluid p-5 bg-light text-black text-center">
        <h1>施工组织设计生成</h1>
        <div class="row text-center" style="margin-top: 28px">
            <div class="input-group mb-2" style="width: 50%">
                <span class="input-group-text">项目名称：</span>
                <input v-model="name" type="text" class="form-control">
            </div>

            <div class="input-group mb-2" style="width: 50%">
                <span class="input-group-text">施工地点：</span>
                <input v-model="address" type="text" class="form-control">
            </div>

            <div class="input-group mb-2" style="width: 50%">
                <span class="input-group-text">开始时间：</span>
                <input v-model="start_date" type="date" class="form-control">
            </div>

            <div class="input-group mb-2" style="width: 50%">
                <span class="input-group-text">截止时间：</span>
                <input v-model="end_date" type="date" class="form-control">
            </div>
        </div>

        <div class="row" style="padding-top: 55px;text-align: left">
            <div class="col">
                <div style="display: flex;flex-direction: row;height: 48px;justify-content: center;text-align: center; line-height: 48px">
                    <h4 algin="center">选择模版</h4>
                    <a href="config.html" style="margin-left: 15px;">配置模版</a>
                </div>
                <div class="card border-info bg-light"
                     style="margin-top: 25px;border-radius:25px;padding: 1.5% 3% 1.5% 3%">
                    <ul class="list-group" style="list-style: none;margin-top:0;padding:0%;">
                        <li v-for="obj in models"
                            style="margin-top: 1.5%;margin-bottom: 1.5%;padding:0">
                            <div class="card"
                                 style="border-radius:25px;padding: 16px;background: white">
                                <div style="display: flex;flex-direction: row" v-if="obj">
                                    <div style="display: flex;flex-direction: column;width: 84%">
                                        <span style="font-size: 22px;color:black;font-weight: 400;line-height: 23px;">
                                        {{ obj.title }}
                                        </span>
                                        <span style="margin-top: 10px">内容模版:</span>
                                        <select v-model="obj.selected" @change="selectOption" style="width: 100%">
                                            <option v-for="(option, index) in obj.contents" :key="index" :value="index"
                                                    style="height: auto">
                                                {{ option }}
                                            </option>
                                        </select>
                                    </div>
                                    <button type="button" class="btn btn-block"
                                            :class="[(obj.inUse) ? 'btn-danger' : 'btn-primary']" @click="useModel(obj)"
                                            style="width: 14%;border-radius:15px;margin-left:2%;margin-top:15px;margin-bottom:15px;">
                                        {{ (obj.inUse) ? "移除" : "使用" }}
                                    </button>

                                </div>

                            </div>

                        </li>
                    </ul>
                </div>
            </div>

            <div class="col">
                <div style="display: flex;flex-direction: row;height: 48px;justify-content: center;text-align: center; line-height: 48px">
                    <h4 style="align-content: center">结果预览</h4>
                    <button id="export_pdf" type="button" class="btn btn-success"
                            style="margin-left: 15px;margin-bottom: 8px"
                            @click="genPDF"
                            :disabled="state!=='complete'"
                            v-if="retLi.length>0">导出PDF
                    </button>
                </div>
                <div id="resultLi" class="card"
                     style="background-color:white;margin-top: 25px;border-radius:25px;padding:16px;"
                     v-if="retLi.length>0">
                    <ul style="list-style: none;margin-top:0;padding-top:0;">
                        <li v-for="(obj,i) in retLi" style="padding-top: 16px;padding-bottom: 16px">
                            <div style="display: flex;flex-direction: row" v-if="obj">
                                <div style="display: flex;flex-direction: column;">
                                    <span style="font-size: 22px;color:black;font-weight: 400;line-height: 23px;">
                                        {{ formatTitle(i, obj.title) }}
                                    </span>
                                    <pre style="margin-top: 15px;width: auto">{{
                                            formatModel(obj.contents[obj.selected])
                                        }}</pre>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

</div>
<div id="file"></div>

<script>
    var app = new Vue({
        el: "#app",
        data: {
            models: [],
            retLi: [],
            selected: -1,
            name: "XX项目",
            address: "成都市",
            start_date: "2023-05-01",
            end_date: "2023-05-01",
            state: ""
        },
        methods: {
            selectOption: function () {

            },
            useModel: function (model) {
                if (model.inUse) {
                    this.retLi = this.retLi.filter(e => e.title !== model.title)
                } else {
                    this.retLi.push(model)
                }
                model.inUse = !model.inUse
            },
            formatTitle: function (i, title) {
                if (i < 10) {
                    return first + arr[i] + end + title
                }
                var high = Math.floor(i / 10)
                var low = i % 10
                console.log("ten:" + high + " Low: " + low)
                if (low === 9) {
                    return first + arr[high] + ten + end + title
                }
                if (high === 1) {
                    return first + ten + arr[low] + end + title
                }
                return first + arr[high - 1] + ten + arr[low] + end + title
            },
            formatModel: function (content) {
                var ret = content
                ret = ret.replace("{{name}}", this.name)
                ret = ret.replace("{{address}}", this.address)
                ret = ret.replace("{{start_date}}", this.start_date)
                ret = ret.replace("{{end_date}}", this.end_date)
                ret = ret.trim()
                return ret
            },

            genPDF: function () {
                var doc = new jsPDF('p', 'mm', 'a4');
                doc.addFont('SourceHanSans-Normal.ttf', 'SourceHanSans-Normal', 'normal');
                doc.setFont('SourceHanSans-Normal', 'bold');
                var cursorY = 20;
                var fontSize = 0;
                var honPadding = 20;
                // 获取 PDF 页面的宽度和高度
                var pdfWidth = doc.internal.pageSize.width;
                var pdfHeight = doc.internal.pageSize.height;
                console.log("pdfWidth: " + pdfWidth + ", pdfHeight:" + pdfHeight)
                app.retLi.forEach(function (obj, i) {
                    var title = app.formatTitle(i, obj.title)
                    if (i > 0) {
                        doc.addPage();
                        cursorY = 20; // 重置 Y 坐标位置为页面顶部
                    }
                    fontSize = 18
                    doc.setFontSize(fontSize);
                    var titleWidth = doc.getStringUnitWidth(title) * doc.internal.getFontSize() / doc.internal.scaleFactor;
                    doc.text(title, (pdfWidth - titleWidth) / 2, cursorY);
                    cursorY += fontSize + 2;
                    var content = app.formatModel(obj.contents[obj.selected]);
                    fontSize = 10
                    doc.setFontSize(fontSize);
                    var lines = doc.splitTextToSize(content, pdfWidth - 2 * honPadding);
                    for (var i = 0; i < lines.length; i++) {
                        if (cursorY > 280) { // 检查导致分页的 Y 坐标位置
                            doc.addPage();
                            cursorY = 20; // 重置 Y 坐标位置为页面顶部
                        }
                        //检查是否插入图片 {pdfImgName:"",width:10,height,10,url:""}
                        var index = lines[i].indexOf('{"pdfImgName');
                        if (index !== -1) {
                            console.log("addImage")
                            var imgJson = "";
                            var i_ = i;
                            while (lines[i].indexOf("}") === -1) {
                                imgJson += lines[i].trim();
                                i++;
                            }
                            if (i > i_) {
                                var str = lines[i].trim()
                                imgJson += str.substring(0, str.indexOf("}")) + "}";
                            }
                            var imgObj = JSON.parse(imgJson);
                            // 定义图片宽度和高度
                            var imgWidth = imgObj.width > 0 ? imgObj.width : 50;
                            var imgHeight = imgObj.height > 0 ? imgObj.height : 50;
                            console.log("imgWidth:" + imgWidth + ", imgHeight:" + imgHeight)
                            var scaleW = 1;
                            var scaleH = 1;
                            if (imgWidth > pdfWidth) {
                                scaleW = pdfWidth / imgWidth
                            }
                            if (imgHeight > pdfHeight) {
                                scaleH = pdfHeight / imgHeight
                            }
                            var scale = scaleW < scaleH ? scaleW : scaleH;
                            console.log("scale:" + scale)
                            imgWidth = imgWidth * scale;
                            imgHeight = imgHeight * scale;
                            if (imgHeight > (pdfHeight - cursorY)) {
                                doc.addPage();
                                cursorY = 20;
                            }
                            // 计算图片需要插入的坐标位置，居中显示
                            var x = (pdfWidth - imgWidth) / 2;
                            // 插入图片到 PDF 中，并居中显示
                            var type = imgObj.src.substring(imgObj.src.indexOf("/") + 1, imgObj.src.indexOf(";"))
                            doc.addImage(imgObj.src, type, x, cursorY, imgWidth, imgHeight);
                            cursorY += imgHeight + 4;
                            if (cursorY > 280) { // 检查导致分页的 Y 坐标位置
                                doc.addPage();
                                cursorY = 20; // 重置 Y 坐标位置为页面顶部
                            }
                            fontSize = 8
                            doc.setFontSize(fontSize);
                            var imgTitleWidth = doc.getStringUnitWidth(imgObj.pdfImgName) * doc.internal.getFontSize() / doc.internal.scaleFactor;
                            doc.text(imgObj.pdfImgName, (pdfWidth - imgTitleWidth) / 2, cursorY);
                            cursorY += fontSize + 2;
                            fontSize = 10
                            doc.setFontSize(10);
                            //图片处理结束
                        } else {
                            doc.text(lines[i], honPadding, cursorY); // 在当前页的给定位置添加文本
                            cursorY += fontSize + 2; // 递增 Y 坐标位置
                        }
                    }
                })
                var result = app.genFileName()
                doc.save(result + ".pdf");
            },
            genFileName: function () {
                var date = new Date()
                console.log(date)
                var year = date.getFullYear()//获取年
                var month = date.getMonth() + 1//获取月
                var day = date.getDate()//获取日
                var hours = date.getHours()//获取时
                var minutes = date.getMinutes()//获取分
                var seconds = date.getSeconds()//获取秒
                month = month > 9 ? month : "0" + month
                day = day > 9 ? day : "0" + day
                hours = hours > 9 ? hours : "0" + hours
                minutes = minutes > 9 ? minutes : "0" + minutes
                // seconds = seconds > 9 ? seconds : "0" + seconds//数据不大于9时在数据前方拼接一个“0”
                var result = "施组_" + year + month + day + "_" + hours + minutes
                return result
            },
        },
    })
    var cacheStr = localStorage.getItem('models')
    if (cacheStr == null || cacheStr.length === 0) {
        app.models = models
    } else {
        app.models = JSON.parse(cacheStr);
    }
    // console.log("Vue:" + JSON.stringify(models))

    const arr = ["一", "二", "三", "四", "五", "六", "七", "八", "九", "十"]
    const first = "第"
    const ten = "十"
    const end = "章  "


    //加载状态为complete时移除loading效果
    function completeLoading() {
        app.state = document.readyState
        console.log("onreadystatechange state: " + app.state)
    }

    //监听加载状态改变
    document.onreadystatechange = completeLoading;
</script>

</body>

</html>